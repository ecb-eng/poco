#!/bin/bash
# 
# Commands to package the project
# 
#	binaries: so it can be distributed
#	sources : so it can be uploaded to a repository
#	publish : publishes the sources package to pedrosans Ubuntu PPA
#	delete  : cleans any built artifact from the project tree
# 
# Dependencies to
# 
#	package: sudo apt-get install python3-stdeb
#	upload : sudo apt install devscripts
# 
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PYTHONPATH="$(dirname $DIR)" && export PYTHONPATH
SETUP_SCRIPT="$PYTHONPATH"/setup.py
VERSION=$(      git describe --abbrev=0 --tags $(git rev-list --tags --skip=0 --max-count=1))
LAST_VERSION=$( git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1))
case "$1" in
	delete)
		rm -rf "$PYTHONPATH"/build "$PYTHONPATH"/deb_dist "$PYTHONPATH"/dist
		rm "$PYTHONPATH"/vimwn-*.tar.gz "$PYTHONPATH"/installed_files.txt "$PYTHONPATH"/tags 2>/dev/null
		;;
	binaries)
		"$DIR"/package delete && echo "Old package deleted"
		echo "Packaging version $VERSION"
		$SETUP_SCRIPT --command-packages=stdeb.command bdist_deb 1>/dev/null && echo "Binaries packaged"
		;;
	sources)
		"$DIR"/package delete && echo "Old package deleted"
		echo "Packaging sources version $VERSION"
		$SETUP_SCRIPT --command-packages=stdeb.command sdist_dsc --forced-upstream-version $VERSION 1>/dev/null \
		&& echo "New version is built" \
		&& sed -i '15,16d' deb_dist/vimwn_$VERSION-1_source.changes \
		&& CHANGES=$(git log master --oneline  --reverse --not $LAST_VERSION) \
		&& xargs -I{} sed -i '15i\   * {}' deb_dist/vimwn_$VERSION-1_source.changes <<<"$CHANGES" \
		&& echo "changes file is up to date, the package is ready to be signed/published"
		;;
	publish)
		debsign -pgpg2 "$PYTHONPATH"/deb_dist/vimwn_$VERSION-1_source.changes && echo "Signed" \
		&& cd "$PYTHONPATH"/deb_dist && dput ppa:pedrosans/vimwn vimwn_$VERSION-1_source.changes && echo "Published"
		;;
	*)
		echo $"Usage: $0 {delete|binaries|sources|publish}"
		exit 1
esac
